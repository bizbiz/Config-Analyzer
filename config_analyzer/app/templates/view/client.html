{# /templates/view/client.html #}
{% extends "base.html" %}
{% from "macros/_table_ui.html" import 
    param_table, 
    card_header, 
    alert_empty_list, 
    display_param_rules,
    display_param_value
%}
{% block title %}Détails du Client : {{ client.name }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="card p-4 shadow-sm mb-4">
        <h1 class="mb-4">Détails du Client : {{ client.name }}</h1>

        <!-- Section Informations générales -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>Informations générales</h5>
                        <dl class="row">
                            <dt class="col-sm-4">Nom</dt>
                            <dd class="col-sm-8">{{ client.name }}</dd>

                            <dt class="col-sm-4">Localisation</dt>
                            <dd class="col-sm-8">
                                {% if client.postal_code_relation %}
                                    {{ client.postal_code_relation.code }} 
                                    {{ client.postal_code_relation.city }}, 
                                    {{ client.postal_code_relation.country_code }}
                                {% else %}
                                    <span class="text-muted">Non renseignée</span>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Section Statistiques -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-chart-bar me-2"></i>Statistiques</h5>
                        <dl class="row">
                            <dt class="col-sm-6">Robots associés</dt>
                            <dd class="col-sm-6">{{ robots|length }}</dd>

                            <dt class="col-sm-6">Fichiers configurations</dt>
                            <dd class="col-sm-6">{{ configurations|length }}</dd>

                            <dt class="col-sm-6">Paramètres client</dt>
                            <dd class="col-sm-6">
                                {{ configured_params|length }}/{{ configured_params|length + unconfigured_params|length }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>

        </div>

        <!-- Section Robots associés -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-robot me-2"></i>Robots associés
                    <span class="badge bg-primary ms-2">{{ robots|length }}</span>
                </h5>
                
                {% if robots %}
                <div class="list-group">
                    {% for robot in robots %}
                    <a href="{{ url_for('robot_instances.view', serial_number=robot.serial_number) }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ robot.serial_number }}</h6>
                            <small class="text-muted">{{ robot.robot_modele.name }}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">
                            {{ robot.software_versions|length }} versions logicielles
                        </span>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>Aucun robot associé à ce client
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Section Configurations -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-file-code me-2"></i>Fichiers de configuration
                    <span class="badge bg-primary ms-2">{{ configurations|length }}</span>
                </h5>
                
                {% if configurations %}
                <div class="row g-4">
                    {% for config in configurations %}
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">
                                    {{ config.snapshot_date.strftime('%d/%m/%Y') }}
                                </h6>
                                <h5 class="card-title">
                                    {% if config.instance_configuration %}
                                        {{ config.instance_configuration.file_name }}
                                    {% else %}
                                        Configuration #{{ config.id }}
                                    {% endif %}
                                </h5>
                                <a href="{{ url_for('parsed_files.view', config_id=config.id) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-search me-2"></i>Inspecter
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>Aucune configuration enregistrée
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Section Paramètres -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-cog me-2"></i>Paramètres spécifiques
                    <span class="badge bg-primary ms-2">{{ (configured_params|length + unconfigured_params|length) }}</span>
                </h5>
                
                {% if configured_params or unconfigured_params %}
                    {{ param_table(
                        configured_params + unconfigured_params, 
                        'client', 
                        client.slug
                    ) }}
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>Aucun paramètre configuré
                        <a href="{{ url_for('additional_params_config.add', entity_type='client', entity_slug=client.slug) }}" class="alert-link">Ajouter un premier paramètre</a>
                    </div>
                {% endif %}
            </div>
        </div>

    <!-- Actions globales -->
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
        <a href="{{ url_for('clients.edit', slug=client.slug) }}" 
           class="btn btn-primary me-md-2">
            <i class="fas fa-edit me-2"></i>Modifier la fiche
        </a>
        <a href="{{ url_for('clients.list') }}" 
           class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Retour à la liste
        </a>
    </div>
</div>
{% endblock %}

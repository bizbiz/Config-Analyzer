{# /templates/macros/_table_ui.html #}
{% macro param_table(params, entity_type, entity_slug, editable=false) %}
<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Nom</th>
                <th>Type</th>
                <th>Règles</th>
                <th>Valeur</th>
                <th class="text-end" style="width: 120px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for param in params %}
            <tr>
                <td>
                    <div class="d-flex flex-column">
                        <span class="fw-bold">{{ param.name }}</span>
                        {% if param.description %}
                        <small class="text-muted">{{ param.description }}</small>
                        {% endif %}
                    </div>
                </td>
                <td>{{ display_param_type_badge(param) }}</td>
                <td>{{ display_param_rules(param) }}</td>
                <td>
                    {% if editable %}
                        {{ display_editable_value(param) }}
                    {% else %}
                        {% if param.active_parameter %}
                            {{ param.active_parameter.value }}
                            <small class="text-muted">(depuis {{ param.active_parameter.created_at|datetimeformat }})</small>
                        {% else %}
                            Non configuré
                        {% endif %}
                    {% endif %}
                </td>
                <td class="text-end">
                    {% if editable %}
                        <button type="button" class="btn btn-sm btn-outline-danger"
                                data-bs-toggle="tooltip" title="Réinitialiser"
                                onclick="this.previousElementSibling.value = ''">
                            <i class="fas fa-undo"></i>
                        </button>
                    {% else %}
                        {{ action_buttons(
                            edit_url=url_for('additional_params_config.edit', config_id=param.id),
                            delete_url=url_for('additional_params_config.delete', config_id=param.id),
                            delete_message="Supprimer ce paramètre ?",
                            is_td=false
                        ) }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endmacro %}


{% macro display_param_rules(param) %}
    {% if param.type.value == 'enum' %}
        {{ ', '.join(param.configuration_values[2:]) }}
    {% elif param.type.value == 'numeric' %}
        Défaut : {{ param.configuration_values[0] }}
        {% if param.configuration_values|length > 1 %}
            (Min: {{ param.configuration_values[1] }},
            Max: {{ param.configuration_values[2] }})
        {% endif %}
    {% else %}
        {{ param.configuration_values[0] if param.configuration_values else 'Non défini' }}
    {% endif %}
{% endmacro %}

{% macro display_param_value(param) %}
    {% if param.active_parameter %}
        {{ param.active_parameter.value }}
        <small class="text-muted">(mis à jour le {{ param.active_parameter.updated_at|datetimeformat }})</small>
    {% else %}
        <span class="text-danger">Non configuré</span>
    {% endif %}
{% endmacro %}


{% macro display_editable_value(param) %}
    {% if param.type.value == 'enum' %}
        <select class="form-select form-select-sm" name="param_{{ param.id }}">
            {% for value in param.configuration_values[2:] %}
            <option value="{{ value }}" 
                {{ 'selected' if param.additional_parameters and value == param.additional_parameters[0].value }}>
                {{ value }}
            </option>
            {% endfor %}
        </select>
    {% else %}
        <input type="{{ 'number' if param.type.value == 'numeric' else 'text' }}" 
               class="form-control form-control-sm" 
               name="param_{{ param.id }}" 
               value="{{ param.additional_parameters[0].value if param.additional_parameters else '' }}">
    {% endif %}
{% endmacro %}

{% macro action_buttons(view_url=None, edit_url=None, delete_url=None, delete_message="Êtes-vous sûr de vouloir supprimer cet élément ?", additional_buttons=[], is_td=true, return_to=request.url) %}
    {% if is_td %}<td class="text-center">{% endif %}
    
    {% if view_url %}
    <a href="{{ view_url }}" class="btn btn-sm btn-info me-1">
        <i class="fas fa-eye"></i>
    </a>
    {% endif %}
    
    {% if edit_url %}
    <a href="{{ edit_url }}" class="btn btn-sm btn-warning me-1">
        <i class="fas fa-edit"></i>
    </a>
    {% endif %}
    
    {% if delete_url %}
    <form action="{{ delete_url }}" method="POST" class="d-inline">
        <input type="hidden" name="return_to" value="{{ return_to }}">
        <button type="submit" class="btn btn-sm btn-danger" 
                onclick="return confirm('{{ delete_message }}')">
            <i class="fas fa-trash"></i>
        </button>
    </form>
    {% endif %}
    
    {% for button in additional_buttons %}
        {{ button|safe }}
    {% endfor %}
    
    {% if is_td %}</td>{% endif %}
{% endmacro %}




{# templates/macros/_pagination.html #}
{% macro render_pagination(page, total_pages, total_items, items_length, offset, endpoint=request.endpoint, endpoint_args=request.view_args) %}
<div class="d-flex justify-content-between align-items-center mt-3">
    <div>
        Affichage de {{ offset + 1 }} à {{ offset + items_length }} sur {{ total_items }} éléments
    </div>
    <nav aria-label="Navigation des pages">
        <ul class="pagination">
            <li class="page-item {{ 'disabled' if page == 1 else '' }}">
                <a class="page-link" href="{{ url_for(endpoint, page=page-1, **endpoint_args) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            
            {% set start_page = [1, page - 2]|max %}
            {% set end_page = [start_page + 4, total_pages]|min %}
            {% set start_page = [end_page - 4, 1]|max %}
            
            {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {{ 'active' if p == page else '' }}">
                    <a class="page-link" href="{{ url_for(endpoint, page=p, **endpoint_args) }}">{{ p }}</a>
                </li>
            {% endfor %}
            
            <li class="page-item {{ 'disabled' if page == total_pages else '' }}">
                <a class="page-link" href="{{ url_for(endpoint, page=page+1, **endpoint_args) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
</div>
{% endmacro %}

{# Fragment pour initialiser la recherche sur un tableau #}
{% macro init_search(table_id, input_id, column_indexes=[], row_selector='tbody tr') %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initTableSearch('{{ table_id }}', '{{ input_id }}', {{ column_indexes|tojson }}, '{{ row_selector }}');
    });
</script>
{% endmacro %}


{# Bouton d'ajout destiné à être placé en haut à droite d'un tableau #}
{% macro card_header(title, add_url=None, add_text="Ajouter", show_button=true, entity_name="élément") %}
<div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">{{ title }}</h5>
    {% if show_button and add_url %}
        <a href="{{ add_url }}" class="btn btn-sm btn-primary">
            <i class="fas fa-plus me-1"></i>{{ add_text|default('Ajouter un ' + entity_name) }}
        </a>
    {% endif %}
</div>
{% endmacro %}

{# Message d'erreur à afficher en cas de liste vide #}
{% macro alert_empty_list(message, add_url=None, add_text=None) %}
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>{{ message }}
    {% if add_url and add_text %}
        <a href="{{ add_url }}" class="alert-link">{{ add_text }}</a>
    {% endif %}
</div>
{% endmacro %}


{% macro display_param_type_badge(config) %}
    {% if config.type.value == 'text' %}
        <span class="badge bg-info">{{ config.type_display }}</span>
    {% elif config.type.value == 'numeric' %}
        <span class="badge bg-primary">{{ config.type_display }}</span>
    {% elif config.type.value == 'enum' %}
        {% set multiple_choice = config.configuration_values[1] == '1' if config.configuration_values else false %}
        <span class="badge bg-success">
            {{ 'Choix multiple' if multiple_choice else 'Choix' }}
        </span>
    {% else %}
        <span class="badge bg-secondary">{{ config.type_display }}</span>
    {% endif %}
{% endmacro %}


{% macro display_param_values(config) %}
{% if config.type.value == 'enum' %}
    {% if config.configuration_values and config.configuration_values|length > 1 %}
        {% set display_values = ", ".join(config.configuration_values[2:]) %}
        {% if config.configuration_values|length > 7 %}
            {{ display_values[:100] }}... ({{ config.configuration_values|length - 2 }} valeurs)
        {% else %}
            {{ display_values[:100] }}
            {% if display_values|length > 100 %}...{% endif %}
        {% endif %}
    {% else %}
        <span class="text-muted">Aucune valeur</span>
    {% endif %}
{% elif config.type.value == 'numeric' %}
    {% set default_value = config.configuration_values[0] if config.configuration_values and config.configuration_values|length > 0 else 'N/A' %}
    {% set min_value = config.configuration_values[1] if config.configuration_values|length > 1 else none %}
    {% set max_value = config.configuration_values[2] if config.configuration_values|length > 2 else none %}
    
    <span class="numeric-values">
        Défaut : {{ default_value }}
        {% if min_value or max_value %}
            <span class="text-muted">
                {% if min_value %}(min: {{ min_value }}{% if max_value %}, {% endif %}{% endif %}
                {% if max_value %}max: {{ max_value }}{% endif %}
                )
            </span>
        {% endif %}
    </span>
{% else %}
    {{ config.configuration_values[0] if config.configuration_values and config.configuration_values|length > 0 else '' }}
{% endif %}
{% endmacro %}


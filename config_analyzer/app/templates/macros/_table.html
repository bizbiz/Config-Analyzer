{# /templates/macros/_table.html #}

{% macro action_buttons(view_url=None, edit_url=None, delete_url=None, delete_message="Êtes-vous sûr de vouloir supprimer cet élément ?", additional_buttons=[], is_td=true, return_to=request.url) %}
    {% if is_td %}<td class="text-center">{% endif %}
    
    {% if view_url %}
    <a href="{{ view_url }}" class="btn btn-sm btn-info me-1">
        <i class="fas fa-eye"></i>
    </a>
    {% endif %}
    
    {% if edit_url %}
    <a href="{{ edit_url }}" class="btn btn-sm btn-warning me-1">
        <i class="fas fa-edit"></i>
    </a>
    {% endif %}
    
    {% if delete_url %}
    <form action="{{ delete_url }}" method="POST" class="d-inline">
        <input type="hidden" name="return_to" value="{{ return_to }}">
        <button type="submit" class="btn btn-sm btn-danger" 
                onclick="return confirm('{{ delete_message }}')">
            <i class="fas fa-trash"></i>
        </button>
    </form>
    {% endif %}
    
    {% for button in additional_buttons %}
        {{ button|safe }}
    {% endfor %}
    
    {% if is_td %}</td>{% endif %}
{% endmacro %}

{% macro init_search(table_id, input_id, column_indexes=[], row_selector='tbody tr') %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initTableSearch('{{ table_id }}', '{{ input_id }}', {{ column_indexes|tojson }}, '{{ row_selector }}');
    });
</script>
{% endmacro %}

{% macro pagination(page, total_pages, total_items, items_length, offset, endpoint=request.endpoint, endpoint_args=request.view_args) %}
<div class="d-flex justify-content-between align-items-center mt-3">
    <div>
        Affichage de {{ offset + 1 }} à {{ offset + items_length }} sur {{ total_items }} éléments
    </div>
    <nav aria-label="Navigation des pages">
        <ul class="pagination">
            <li class="page-item {{ 'disabled' if page == 1 else '' }}">
                <a class="page-link" href="{{ url_for(endpoint, page=page-1, **endpoint_args) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            
            {% set start_page = [1, page - 2]|max %}
            {% set end_page = [start_page + 4, total_pages]|min %}
            {% set start_page = [end_page - 4, 1]|max %}
            
            {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {{ 'active' if p == page else '' }}">
                    <a class="page-link" href="{{ url_for(endpoint, page=p, **endpoint_args) }}">{{ p }}</a>
                </li>
            {% endfor %}
            
            <li class="page-item {{ 'disabled' if page == total_pages else '' }}">
                <a class="page-link" href="{{ url_for(endpoint, page=page+1, **endpoint_args) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
</div>
{% endmacro %}

{% macro display_param_type_badge(config) %}
    {% if config.type.value == 'text' %}
        <span class="badge bg-info">{{ config.type_display }}</span>
    {% elif config.type.value == 'numeric' %}
        <span class="badge bg-primary">{{ config.type_display }}</span>
    {% elif config.type.value == 'enum' %}
        {% set multiple_choice = config.configuration_values[1] == '1' if config.configuration_values else false %}
        <span class="badge bg-success">
            {{ 'Choix multiple' if multiple_choice else 'Choix' }}
        </span>
    {% else %}
        <span class="badge bg-secondary">{{ config.type_display }}</span>
    {% endif %}
{% endmacro %}

{% macro display_param_values(config) %}
{% if config.type.value == 'enum' %}
    {% if config.configuration_values and config.configuration_values|length > 1 %}
        {% set display_values = ", ".join(config.configuration_values[2:]) %}
        {% if config.configuration_values|length > 7 %}
            {{ display_values[:100] }}... ({{ config.configuration_values|length - 2 }} valeurs)
        {% else %}
            {{ display_values[:100] }}
            {% if display_values|length > 100 %}...{% endif %}
        {% endif %}
    {% else %}
        <span class="text-muted">Aucune valeur</span>
    {% endif %}
{% elif config.type.value == 'numeric' %}
    {% set default_value = config.configuration_values[0] if config.configuration_values and config.configuration_values|length > 0 else 'N/A' %}
    {% set min_value = config.configuration_values[1] if config.configuration_values|length > 1 else none %}
    {% set max_value = config.configuration_values[2] if config.configuration_values|length > 2 else none %}
    
    <span class="numeric-values">
        Défaut : {{ default_value }}
        {% if min_value or max_value %}
            <span class="text-muted">
                {% if min_value %}(min: {{ min_value }}{% if max_value %}, {% endif %}{% endif %}
                {% if max_value %}max: {{ max_value }}{% endif %}
                )
            </span>
        {% endif %}
    </span>
{% else %}
    {{ config.configuration_values[0] if config.configuration_values and config.configuration_values|length > 0 else '' }}
{% endif %}
{% endmacro %}

{% macro display_param_rules(param) %}
    {% if param.type.value == 'numeric' %}
        Val: {{ param.configuration_values[0] }}
        {% if param.configuration_values|length > 1 %} 
            (Min: {{ param.configuration_values[1] }}, Max: {{ param.configuration_values[2] }})
        {% endif %}
    {% elif param.type.value == 'enum' %}
        Options: {{ param.configuration_values[2:]|join(', ') }}
    {% else %}
        Texte libre
    {% endif %}
{% endmacro %}

{% macro param_table(params, entity_type, entity_slug, editable=false) %}
<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Nom</th>
                <th>Type</th>
                <th>Règles</th>
                <th>Valeur</th>
                {% if editable %}<th class="text-end">Actions</th>{% endif %}
            </tr>
        </thead>
        <tbody>
            {% for param in params %}
            <tr>
                <td>{{ param.name }}</td>
                <td>{{ display_param_type_badge(param) }}</td>
                <td>{{ display_param_rules(param) }}</td>
                <td>
                    {% if editable %}
                        {{ display_editable_value(param) }}
                    {% else %}
                        {{ display_param_value(param) }}
                    {% endif %}
                </td>
                {% if editable %}
                <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger reset-param"
                            data-param-id="{{ param.id }}">
                        <i class="fas fa-undo"></i>
                    </button>
                </td>
                {% endif %}
            </tr>

            {# Ajouter ce bloc conditionnel pour les explications #}
            {% if editable %}
            <tr class="notes-row" id="notes-row-{{ param.id }}" style="display: none;">
                <td colspan="{% if editable %}5{% else %}4{% endif %}">
                    <div class="notes-container p-3 bg-light">
                        <textarea class="form-control" 
                                  name="notes_{{ param.id }}"
                                  placeholder="Explications sur les raisons de la modification (facultatif)"
                                  rows="2"></textarea>
                    </div>
                </td>
            </tr>
            {% endif %}

            {% endfor %}
        </tbody>
    </table>
</div>
{% endmacro %}

{% macro display_editable_value(param) %}
{% if param.type.value == 'enum' %}
    <select class="form-select form-select-sm param-value-input"
            name="param_{{ param.id }}"
            data-param-id="{{ param.id }}"
            data-original-value="{{ param.active_parameter.value if param.active_parameter else '' }}">
        {% for value in param.configuration_values[2:] %}
        <option value="{{ value }}" {{ 'selected' if param.active_parameter and value == param.active_parameter.value }}>
            {{ value }}
        </option>
        {% endfor %}
    </select>
{% else %}
    <input type="{{ 'number' if param.type.value == 'numeric' else 'text' }}"
           class="form-control form-control-sm param-value-input"
           name="param_{{ param.id }}"
           data-param-id="{{ param.id }}"
           data-original-value="{{ param.active_parameter.value if param.active_parameter else '' }}"
           value="{{ param.active_parameter.value if param.active_parameter else '' }}">
{% endif %}
{% endmacro %}
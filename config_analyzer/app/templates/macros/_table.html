{# /templates/macros/_table.html #}

{#
/**
 * Macro data_table - Affiche un tableau de données avec des fonctionnalités avancées
 *
 * Cette macro génère un tableau de données complet avec support pour la recherche,
 * le tri, la pagination, et des actions personnalisables.
 *
 * @param entity_type       String  Type d'entité (ex: 'client', 'robot_model')
 * @param items             Array   Liste des éléments à afficher dans le tableau
 * @param title             String  Titre du tableau (facultatif)
 * @param icon              String  Icône FontAwesome (ex: 'users')
 * @param add_url           String  URL pour le bouton d'ajout (null pour masquer)
 * @param add_text          String  Texte du bouton d'ajout (défaut: "Ajouter")
 * @param actions           Bool    Afficher la colonne d'actions (défaut: true)
 * @param search            Bool    Activer la recherche (défaut: true)
 * @param pagination        Bool    Activer la pagination (défaut: true)
 * @param filters           Object  Configuration des filtres {nom: [options]}
 * @param sort_options      Array   Colonnes triables (défaut: [])
 * @param custom_row_classes Func   Fonction pour ajouter des classes aux lignes
 * @param additional_buttons Array   Boutons supplémentaires pour l'en-tête
 * @param show_export       Bool    Afficher le bouton d'exportation (défaut: false)
 * @param export_url        String  URL pour l'exportation
 * @param export_label      String  Texte du bouton d'exportation (défaut: "Exporter")
 * @param empty_message     String  Message quand aucun élément n'est trouvé
 * @param bulk_actions      Array   Actions en masse pour lignes sélectionnées
 * @param row_click_action  String  Action lors du clic sur une ligne (ex: 'view')
 * @param refresh_interval  Number  Intervalle de rafraîchissement en ms
 * @param table_class       String  Classes CSS additionnelles pour le tableau
 * @param show_count        Bool    Afficher le nombre d'éléments (défaut: true)
 * @param custom_actions    Object  Actions personnalisées {nom: {icon, label, url}}
 * @param table_id          String  ID du tableau (défaut: entity_type + "-table")
 * @param search_input_id   String  ID du champ de recherche
 * @param filter_columns    Number  Nombre de colonnes pour la recherche
 * @param tbody_id          String  ID du tbody
 * @param show_badge        Bool    Afficher badge avec nombre d'éléments
 * @param is_embedded       Bool    Indique si tableau est intégré dans un autre
 * @param hide_client       Bool    Masquer colonne client (tableaux intégrés)
 * @param hide_model        Bool    Masquer colonne modèle (tableaux intégrés)
 * @param show_sort         Bool    Afficher contrôles de tri (défaut: false)
 * @param show_search       Bool    Afficher champ de recherche (défaut: true)
 * @param search_placeholder String  Placeholder du champ de recherche
 * @param force_add_button  Bool    Forcer bouton d'ajout même si vide
 * @param hide_add_when_empty Bool   Masquer bouton d'ajout si liste vide
 * @param template_partial  String  Template partiel à utiliser pour corps tableau
 * @param context           Object  Contexte à passer au template partiel
 *
 * Exemple d'utilisation basique:
 * {{ data_table(
 *     entity_type='client',
 *     items=clients,
 *     title='Liste des clients',
 *     icon='users',
 *     add_url=url_for('clients.add'),
 *     template_partial='list/partials/clients.html',
 *     context={
 *         'items': clients,
 *         'show_add_button': false
 *     }
 * ) }}
 *
 * Exemple avec options avancées:
 * {{ data_table(
 *     entity_type='client',
 *     items=clients,
 *     title='Liste des clients',
 *     icon='users',
 *     add_url=url_for('clients.add'),
 *     search=true,
 *     pagination=true,
 *     filters={'country': countries},
 *     sort_options=['name', 'city'],
 *     show_export=true,
 *     export_url=url_for('clients.export'),
 *     template_partial='list/partials/clients.html',
 *     context={
 *         'items': clients,
 *         'show_search': true,
 *         'show_actions': true
 *     },
 *     bulk_actions=[
 *         {'label': 'Supprimer', 'icon': 'trash', 'action': 'delete'}
 *     ]
 * ) }}
 */
#}

{% macro data_table(
    entity_type,
    items,
    title=None,
    icon=None,
    add_url=None,
    add_text="Ajouter",
    show_add_button=true,
    actions=true,
    search=true,
    pagination=false,
    filters={},
    sort_options=[],
    custom_row_classes=None,
    additional_buttons=[],
    show_export=false,
    export_url=None,
    export_label="Exporter",
    empty_message="Aucun élément trouvé.",
    bulk_actions=[],
    row_click_action=None,
    refresh_interval=None,
    table_class="",
    show_count=true,
    custom_actions={},
    table_id=None,
    search_input_id=None,
    filter_columns=3,
    tbody_id=None,
    show_badge=false,
    is_embedded=false,
    show_sort=false,
    show_search=true,
    search_placeholder=None,
    force_add_button=true,
    hide_add_when_empty=false,
    headers=[],
    columns=[],
    column_links={},
    view_url_pattern=None,
    delete_message="Êtes-vous sûr de vouloir supprimer cet élément ?"
) %}
    {# Calcul des IDs du tableau si non fournis #}
    {% set table_id = table_id|default(entity_type + 'Table') %}
    {% set search_input_id = search_input_id|default(entity_type + 'SearchInput') %}
    {% set tbody_id = tbody_id|default(entity_type + '-table-body') %}
    {% set search_placeholder = search_placeholder|default('Rechercher un ' + entity_type + '...') %}

    <div class="card {% if not is_embedded %}mt-4{% endif %}">
        {# En-tête avec titre et boutons d'action #}
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                {% if icon %}<i class="fas fa-{{ icon }} me-2"></i>{% endif %}
                {{ title }}
                {% if show_badge %}
                <span class="badge bg-primary ms-2">{{ items|length }}</span>
                {% endif %}
            </h5>
            
            <div class="d-flex">
                {# Boutons supplémentaires #}
                {% for button in additional_buttons %}
                <a href="{{ button.url }}" class="btn btn-sm {{ button.class|default('btn-secondary') }} me-2">
                    {% if button.icon %}<i class="fas fa-{{ button.icon }} me-1"></i>{% endif %}
                    {{ button.text }}
                </a>
                {% endfor %}
                
                {# Bouton d'exportation si activé #}
                {% if show_export and export_url %}
                <a href="{{ export_url }}" class="btn btn-sm btn-secondary me-2">
                    <i class="fas fa-download me-1"></i>{{ export_label }}
                </a>
                {% endif %}
                
                {# Bouton d'ajout #}
                {% if add_url and show_add_button and (items|length > 0 or not hide_add_when_empty or force_add_button) %}
                <a href="{{ add_url }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus me-1"></i>{{ add_text }}
                </a>
                {% endif %}
            </div>
        </div>
        
        <div class="card-body">
            {% if items|length > 0 %}
                {# Champ de recherche #}
                {% if search and show_search %}
                <div class="mb-3">
                    <input type="text" id="{{ search_input_id }}" class="form-control" 
                           placeholder="{{ search_placeholder }}">
                </div>
                {% endif %}
                
                {# Tableau principal - rendu direct sans template partiel #}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle {{ table_class }}" 
                           id="{{ table_id }}"
                           data-list-filter="{{ 'true' if search else 'false' }}"
                           data-filter-input="{{ search_input_id }}" 
                           data-filter-columns="{{ filter_columns }}">
                        <thead class="table-light">
                            <tr>
                                {% if bulk_actions|length > 0 %}
                                <th class="bulk-select-column">
                                    <input type="checkbox" class="select-all-checkbox">
                                </th>
                                {% endif %}
                                
                                {% for header in headers %}
                                <th>{{ header }}</th>
                                {% endfor %}
                                
                                {% if actions %}
                                <th class="actions-column">Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody id="{{ tbody_id }}">
                            {% for item in items %}
                            <tr {% if custom_row_classes %}class="{{ custom_row_classes(item) }}"{% endif %}
                                {% if row_click_action %}data-clickable="true"{% endif %}>
                                
                                {% if bulk_actions|length > 0 %}
                                <td class="bulk-select-column">
                                    <input type="checkbox" class="row-checkbox" data-id="{{ item.id }}">
                                </td>
                                {% endif %}
                                
                                {% for column in columns %}
                                <td>
                                    {# Gestion des attributs imbriqués comme postal_code_relation.code #}
                                    {% set value = item %}
                                    {% for attr in column.split('.') %}
                                        {% if value is not none and attr in value|keys %}
                                            {% set value = value[attr] %}
                                        {% elif value is not none and hasattr(value, attr) %}
                                            {% set value = attribute(value, attr) %}
                                        {% else %}
                                            {% set value = '' %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {# Gestion des liens pour cette colonne si définis #}
                                    {% if column in column_links and value %}
                                        <a href="{{ column_links[column]|replace({'%id%': item.id, '%slug%': item.slug}) }}">
                                            {{ value }}
                                        </a>
                                    {% elif loop.first and view_url_pattern and (item.id or item.slug) %}
                                        {# Premier colonne est un lien par défaut si view_url_pattern est fourni #}
                                        <a href="{{ view_url_pattern|replace({'%id%': item.id, '%slug%': item.slug}) }}">
                                            {{ value }}
                                        </a>
                                    {% else %}
                                        {{ value }}
                                    {% endif %}
                                </td>
                                {% endfor %}
                                
                                {% if actions %}
                                <td class="text-center">
                                    {{ action_buttons(
                                        view_url=custom_actions.view_url|default(url_for(entity_type + '.view', slug=item.slug) if hasattr(item, 'slug') else url_for(entity_type + '.view', id=item.id)),
                                        edit_url=custom_actions.edit_url|default(url_for(entity_type + '.edit', slug=item.slug) if hasattr(item, 'slug') else url_for(entity_type + '.edit', id=item.id)),
                                        delete_url=custom_actions.delete_url|default(url_for(entity_type + '.delete', slug=item.slug) if hasattr(item, 'slug') else url_for(entity_type + '.delete', id=item.id)),
                                        delete_message=delete_message,
                                        additional_buttons=custom_actions.additional_buttons|default([])
                                    ) }}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {# Initialisation de la recherche #}
                {% if search %}
                    {{ init_search(table_id, search_input_id) }}
                {% endif %}
                
                {# Pagination #}
                {% if pagination and total_pages is defined and total_pages > 1 %}
                    {{ pagination(page, total_pages, total_items, items|length, offset) }}
                {% endif %}
                
            {% else %}
                {# Message si aucun élément #}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>{{ empty_message }}
                    {% if add_url and (show_add_button and not hide_add_when_empty) %}
                        <a href="{{ add_url }}" class="alert-link">{{ add_text }}</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
{% endmacro %}

{% macro action_buttons(view_url=None, edit_url=None, delete_url=None, delete_message="Êtes-vous sûr de vouloir supprimer cet élément ?", additional_buttons=[], is_td=true, return_to=request.url) %}
    {% if is_td %}<td class="text-center">{% endif %}
    
    {% if view_url %}
    <a href="{{ view_url }}" class="btn btn-sm btn-info me-1">
        <i class="fas fa-eye"></i>
    </a>
    {% endif %}
    
    {% if edit_url %}
    <a href="{{ edit_url }}" class="btn btn-sm btn-warning me-1">
        <i class="fas fa-edit"></i>
    </a>
    {% endif %}
    
    {% if delete_url %}
    <form action="{{ delete_url }}" method="POST" class="d-inline">
        <input type="hidden" name="return_to" value="{{ return_to }}">
        <button type="submit" class="btn btn-sm btn-danger" 
                onclick="return confirm('{{ delete_message }}')">
            <i class="fas fa-trash"></i>
        </button>
    </form>
    {% endif %}
    
    {% for button in additional_buttons %}
        {{ button|safe }}
    {% endfor %}
    
    {% if is_td %}</td>{% endif %}
{% endmacro %}

{% macro init_search(table_id, input_id, column_indexes=[], row_selector='tbody tr') %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initTableSearch('{{ table_id }}', '{{ input_id }}', {{ column_indexes|tojson }}, '{{ row_selector }}');
    });
</script>
{% endmacro %}

{% macro pagination(page, total_pages, total_items, items_length, offset, endpoint=request.endpoint, endpoint_args=request.view_args) %}
<div class="d-flex justify-content-between align-items-center mt-3">
    <div>
        Affichage de {{ offset + 1 }} à {{ offset + items_length }} sur {{ total_items }} éléments
    </div>
    <nav aria-label="Navigation des pages">
        <ul class="pagination">
            <li class="page-item {{ 'disabled' if page == 1 else '' }}">
                <a class="page-link" href="{{ url_for(endpoint, page=page-1, **endpoint_args) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            
            {% set start_page = [1, page - 2]|max %}
            {% set end_page = [start_page + 4, total_pages]|min %}
            {% set start_page = [end_page - 4, 1]|max %}
            
            {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {{ 'active' if p == page else '' }}">
                    <a class="page-link" href="{{ url_for(endpoint, page=p, **endpoint_args) }}">{{ p }}</a>
                </li>
            {% endfor %}
            
            <li class="page-item {{ 'disabled' if page == total_pages else '' }}">
                <a class="page-link" href="{{ url_for(endpoint, page=page+1, **endpoint_args) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
</div>
{% endmacro %}

{% macro display_param_type_badge(config) %}
    {% if config.type.value == 'text' %}
        <span class="badge bg-info">{{ config.type_display }}</span>
    {% elif config.type.value == 'numeric' %}
        <span class="badge bg-primary">{{ config.type_display }}</span>
    {% elif config.type.value == 'enum' %}
        {% set multiple_choice = config.configuration_values[1] == '1' if config.configuration_values else false %}
        <span class="badge bg-success">
            {{ 'Choix multiple' if multiple_choice else 'Choix' }}
        </span>
    {% else %}
        <span class="badge bg-secondary">{{ config.type_display }}</span>
    {% endif %}
{% endmacro %}

{% macro display_param_values(config) %}
{% if config.type.value == 'enum' %}
    {% if config.configuration_values and config.configuration_values|length > 1 %}
        {% set display_values = ", ".join(config.configuration_values[2:]) %}
        {% if config.configuration_values|length > 7 %}
            {{ display_values[:100] }}... ({{ config.configuration_values|length - 2 }} valeurs)
        {% else %}
            {{ display_values[:100] }}
            {% if display_values|length > 100 %}...{% endif %}
        {% endif %}
    {% else %}
        <span class="text-muted">Aucune valeur</span>
    {% endif %}
{% elif config.type.value == 'numeric' %}
    {% set default_value = config.configuration_values[0] if config.configuration_values and config.configuration_values|length > 0 else 'N/A' %}
    {% set min_value = config.configuration_values[1] if config.configuration_values|length > 1 else none %}
    {% set max_value = config.configuration_values[2] if config.configuration_values|length > 2 else none %}
    
    <span class="numeric-values">
        Défaut : {{ default_value }}
        {% if min_value or max_value %}
            <span class="text-muted">
                {% if min_value %}(min: {{ min_value }}{% if max_value %}, {% endif %}{% endif %}
                {% if max_value %}max: {{ max_value }}{% endif %}
                )
            </span>
        {% endif %}
    </span>
{% else %}
    {{ config.configuration_values[0] if config.configuration_values and config.configuration_values|length > 0 else '' }}
{% endif %}
{% endmacro %}

{% macro display_param_rules(param) %}
    {% if param.type.value == 'numeric' %}
        Val: {{ param.configuration_values[0] }}
        {% if param.configuration_values|length > 1 %} 
            (Min: {{ param.configuration_values[1] }}, Max: {{ param.configuration_values[2] }})
        {% endif %}
    {% elif param.type.value == 'enum' %}
        Options: {{ param.configuration_values[2:]|join(', ') }}
    {% else %}
        Texte libre
    {% endif %}
{% endmacro %}

{% macro param_table(params, entity_type, entity_slug, editable=false) %}
<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Nom</th>
                <th>Type</th>
                <th>Règles</th>
                <th>Valeur</th>
                {% if editable %}<th class="text-end">Actions</th>{% endif %}
            </tr>
        </thead>
        <tbody>
            {% for param in params %}
            <tr>
                <td>{{ param.name }}</td>
                <td>{{ display_param_type_badge(param) }}</td>
                <td>{{ display_param_rules(param) }}</td>
                <td>
                    {% if editable %}
                        {{ display_editable_value(param) }}
                    {% else %}
                        {{ display_param_value(param) }}
                    {% endif %}
                </td>
                {% if editable %}
                <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger reset-param"
                            data-param-id="{{ param.id }}">
                        <i class="fas fa-undo"></i>
                    </button>
                </td>
                {% endif %}
            </tr>

            {# Ajouter ce bloc conditionnel pour les explications #}
            {% if editable %}
            <tr class="notes-row" id="notes-row-{{ param.id }}" style="display: none;">
                <td colspan="{% if editable %}5{% else %}4{% endif %}">
                    <div class="notes-container p-3 bg-light">
                        <textarea class="form-control" 
                                  name="notes_{{ param.id }}"
                                  placeholder="Explications sur les raisons de la modification (facultatif)"
                                  rows="2"></textarea>
                    </div>
                </td>
            </tr>
            {% endif %}

            {% endfor %}
        </tbody>
    </table>
</div>
{% endmacro %}

{% macro display_editable_value(param) %}
{% if param.type.value == 'enum' %}
    <select class="form-select form-select-sm param-value-input"
            name="param_{{ param.id }}"
            data-param-id="{{ param.id }}"
            data-original-value="{{ param.active_parameter.value if param.active_parameter else '' }}">
        {% for value in param.configuration_values[2:] %}
        <option value="{{ value }}" {{ 'selected' if param.active_parameter and value == param.active_parameter.value }}>
            {{ value }}
        </option>
        {% endfor %}
    </select>
{% else %}
    <input type="{{ 'number' if param.type.value == 'numeric' else 'text' }}"
           class="form-control form-control-sm param-value-input"
           name="param_{{ param.id }}"
           data-param-id="{{ param.id }}"
           data-original-value="{{ param.active_parameter.value if param.active_parameter else '' }}"
           value="{{ param.active_parameter.value if param.active_parameter else '' }}">
{% endif %}
{% endmacro %}

{# Macro pour la liste vide - simplifiée pour éviter l'opérateur ternaire incorrect #}
{% macro alert_empty_list(message, add_url=None, add_text=None) %}
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>{{ message }}
    {% if add_url and add_text %}
        <a href="{{ add_url }}" class="alert-link">{{ add_text }}</a>
    {% endif %}
</div>
{% endmacro %}
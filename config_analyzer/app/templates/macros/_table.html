{# /templates/macros/_table.html #}

{# Macro principale pour l'affichage des tableaux - version complète #}
{% macro data_table(
    entity_type,
    items,
    headers,
    columns,
    title=null,
    icon=null,
    add_url=null,
    add_label="Ajouter",
    actions=true,
    search=true,
    pagination=true,
    filters={},
    sort_options=[],
    custom_row_classes=null,
    additional_buttons=[],
    show_export=false,
    export_url=null,
    export_label="Exporter",
    empty_message="Aucun élément trouvé",
    bulk_actions=[],
    row_click_action=null,
    refresh_interval=null,
    table_class="",
    show_count=true,
    custom_actions={}
) %}
    <div class="data-table-container" data-entity-type="{{ entity_type }}" 
         {% if refresh_interval %}data-refresh="{{ refresh_interval }}"{% endif %}>
        
        {# En-tête du tableau avec titre et boutons principaux #}
        <div class="table-header">
            {% if title %}
            <h2 class="table-title">
                {% if icon %}<i class="fa fa-{{ icon }}"></i>{% endif %}
                {{ title }}
                {% if show_count %}
                <span class="item-count">({{ items|length }})</span>
                {% endif %}
            </h2>
            {% endif %}
            
            <div class="header-actions">
                {% if add_url %}
                <a href="{{ add_url }}" class="btn btn-primary add-btn">
                    <i class="fa fa-plus"></i> {{ add_label }}
                </a>
                {% endif %}
                
                {% if show_export %}
                <a href="{{ export_url }}" class="btn btn-secondary export-btn">
                    <i class="fa fa-download"></i> {{ export_label }}
                </a>
                {% endif %}
                
                {% for button in additional_buttons %}
                <button class="btn {{ button.class|default('btn-secondary') }}" 
                        {% if button.id %}id="{{ button.id }}"{% endif %}
                        {% if button.action %}data-action="{{ button.action }}"{% endif %}
                        {% if button.url %}onclick="window.location.href='{{ button.url }}'"{% endif %}
                        {% for attr, value in button.attributes|default({}) %}
                            {{ attr }}="{{ value }}"
                        {% endfor %}>
                    {% if button.icon %}<i class="fa fa-{{ button.icon }}"></i>{% endif %}
                    {{ button.label }}
                </button>
                {% endfor %}
            </div>
        </div>
        
        {# Contrôles de table (recherche, filtres, tri) #}
        {% if search or filters|length > 0 or sort_options|length > 0 %}
        <div class="table-controls">
            {% if search %}
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Rechercher..." 
                       data-search-target="{{ entity_type }}-table">
                <button class="search-button">
                    <i class="fa fa-search"></i>
                </button>
            </div>
            {% endif %}
            
            {% if filters|length > 0 %}
            <div class="filters-container">
                {% for filter_name, filter_options in filters %}
                <div class="filter-group">
                    <label>{{ filter_name|title }}</label>
                    <select data-filter="{{ filter_name }}">
                        <option value="">Tous</option>
                        {% for option in filter_options %}
                            {% if option is iterable and option.value is defined %}
                                <option value="{{ option.value }}">{{ option.label }}</option>
                            {% else %}
                                <option value="{{ option }}">{{ option|title }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if sort_options|length > 0 %}
            <div class="sort-container">
                <label>Trier par</label>
                <select data-sort-table="{{ entity_type }}-table">
                    {% for sort_option in sort_options %}
                        {% if sort_option is iterable and sort_option.value is defined %}
                            <option value="{{ sort_option.value }}">{{ sort_option.label }}</option>
                        {% else %}
                            <option value="{{ sort_option }}">{{ headers[sort_option] }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <button class="sort-direction" data-direction="asc">
                    <i class="fa fa-arrow-up"></i>
                </button>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        {# Actions en masse si activées #}
        {% if bulk_actions|length > 0 %}
        <div class="bulk-actions" style="display: none;">
            <span class="selected-count">0 élément(s) sélectionné(s)</span>
            {% for action in bulk_actions %}
            <button class="bulk-action-btn" data-action="{{ action.action }}">
                {% if action.icon %}<i class="fa fa-{{ action.icon }}"></i>{% endif %}
                {{ action.label }}
            </button>
            {% endfor %}
        </div>
        {% endif %}
        
        {# Tableau principal #}
        <div class="table-responsive">
            <table id="{{ entity_type }}-table" class="data-table {{ table_class }}"
                  {% if row_click_action %}data-row-action="{{ row_click_action }}"{% endif %}
                  {% if bulk_actions|length > 0 %}data-bulk-select="true"{% endif %}>
                <thead>
                    <tr>
                        {% if bulk_actions|length > 0 %}
                        <th class="bulk-select-column">
                            <input type="checkbox" class="select-all-checkbox">
                        </th>
                        {% endif %}
                        
                        {% for column_id, header_text in headers %}
                        <th data-column="{{ column_id }}" 
                            {% if column_id in sort_options %}data-sortable="true"{% endif %}>
                            {{ header_text }}
                        </th>
                        {% endfor %}
                        
                        {% if actions %}
                        <th class="actions-column">Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% if items|length > 0 %}
                        {% for item in items %}
                        <tr {% if custom_row_classes %}
                            class="{{ custom_row_classes(item) }}"
                            {% endif %}
                            data-id="{{ item.id }}" 
                            {% if row_click_action %}data-clickable="true"{% endif %}>
                            
                            {% if bulk_actions|length > 0 %}
                            <td class="bulk-select-column">
                                <input type="checkbox" class="row-checkbox" data-id="{{ item.id }}">
                            </td>
                            {% endif %}
                            
                            {% for column_id, column_path in columns %}
                            <td data-column="{{ column_id }}">
                                {{ _render_column_value(item, column_path)|raw }}
                            </td>
                            {% endfor %}
                            
                            {% if actions %}
                            <td class="actions-cell">
                                <div class="action-buttons">
                                    {% if custom_actions.view is not defined or custom_actions.view %}
                                    <a href="{{ path(entity_type ~ '_view', {'id': item.id}) }}" 
                                       class="action-btn view" title="Voir">
                                        <i class="fa fa-eye"></i>
                                    </a>
                                    {% endif %}
                                    
                                    {% if custom_actions.edit is not defined or custom_actions.edit %}
                                    <a href="{{ path(entity_type ~ '_edit', {'id': item.id}) }}" 
                                       class="action-btn edit" title="Modifier">
                                        <i class="fa fa-pencil"></i>
                                    </a>
                                    {% endif %}
                                    
                                    {% if custom_actions.delete is not defined or custom_actions.delete %}
                                    <button class="action-btn delete" 
                                            data-delete-id="{{ item.id }}"
                                            data-delete-type="{{ entity_type }}"
                                            title="Supprimer">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                    {% endif %}
                                    
                                    {# Actions personnalisées supplémentaires #}
                                    {% for action_key, action in custom_actions %}
                                        {% if action_key not in ['view', 'edit', 'delete'] and action %}
                                            {% if action.url is defined %}
                                            <a href="{{ action.url|replace({'%id%': item.id}) }}" 
                                               class="action-btn {{ action_key }}" 
                                               title="{{ action.label|default(action_key|title) }}">
                                                <i class="fa fa-{{ action.icon|default('cog') }}"></i>
                                            </a>
                                            {% else %}
                                            <button class="action-btn {{ action_key }}"
                                                    data-id="{{ item.id }}"
                                                    data-action="{{ action_key }}"
                                                    title="{{ action.label|default(action_key|title) }}">
                                                <i class="fa fa-{{ action.icon|default('cog') }}"></i>
                                            </button>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr class="empty-table">
                            <td colspan="{{ headers|length + (actions ? 1 : 0) + (bulk_actions|length > 0 ? 1 : 0) }}">
                                {{ empty_message }}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        {# Pagination #}
        {% if pagination and items|length > 0 %}
        <div class="pagination">
            <div class="pagination-controls">
                <button class="page-prev" {% if page is defined and page <= 1 %}disabled{% endif %}>
                    <i class="fa fa-chevron-left"></i>
                </button>
                
                <span class="page-info">
                    Page <span class="current-page">{{ page|default(1) }}</span> 
                    sur <span class="total-pages">{{ total_pages|default(1) }}</span>
                </span>
                
                <button class="page-next" {% if page is defined and page >= total_pages %}disabled{% endif %}>
                    <i class="fa fa-chevron-right"></i>
                </button>
            </div>
            
            {% if items_per_page_options is defined %}
            <div class="items-per-page">
                <label>Éléments par page</label>
                <select class="per-page-select">
                    {% for option in items_per_page_options %}
                    <option value="{{ option }}" 
                            {% if items_per_page is defined and items_per_page == option %}selected{% endif %}>
                        {{ option }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
{% endmacro %}

{% macro action_buttons(view_url=None, edit_url=None, delete_url=None, delete_message="Êtes-vous sûr de vouloir supprimer cet élément ?", additional_buttons=[], is_td=true, return_to=request.url) %}
    {% if is_td %}<td class="text-center">{% endif %}
    
    {% if view_url %}
    <a href="{{ view_url }}" class="btn btn-sm btn-info me-1">
        <i class="fas fa-eye"></i>
    </a>
    {% endif %}
    
    {% if edit_url %}
    <a href="{{ edit_url }}" class="btn btn-sm btn-warning me-1">
        <i class="fas fa-edit"></i>
    </a>
    {% endif %}
    
    {% if delete_url %}
    <form action="{{ delete_url }}" method="POST" class="d-inline">
        <input type="hidden" name="return_to" value="{{ return_to }}">
        <button type="submit" class="btn btn-sm btn-danger" 
                onclick="return confirm('{{ delete_message }}')">
            <i class="fas fa-trash"></i>
        </button>
    </form>
    {% endif %}
    
    {% for button in additional_buttons %}
        {{ button|safe }}
    {% endfor %}
    
    {% if is_td %}</td>{% endif %}
{% endmacro %}

{% macro init_search(table_id, input_id, column_indexes=[], row_selector='tbody tr') %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initTableSearch('{{ table_id }}', '{{ input_id }}', {{ column_indexes|tojson }}, '{{ row_selector }}');
    });
</script>
{% endmacro %}

{% macro pagination(page, total_pages, total_items, items_length, offset, endpoint=request.endpoint, endpoint_args=request.view_args) %}
<div class="d-flex justify-content-between align-items-center mt-3">
    <div>
        Affichage de {{ offset + 1 }} à {{ offset + items_length }} sur {{ total_items }} éléments
    </div>
    <nav aria-label="Navigation des pages">
        <ul class="pagination">
            <li class="page-item {{ 'disabled' if page == 1 else '' }}">
                <a class="page-link" href="{{ url_for(endpoint, page=page-1, **endpoint_args) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            
            {% set start_page = [1, page - 2]|max %}
            {% set end_page = [start_page + 4, total_pages]|min %}
            {% set start_page = [end_page - 4, 1]|max %}
            
            {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {{ 'active' if p == page else '' }}">
                    <a class="page-link" href="{{ url_for(endpoint, page=p, **endpoint_args) }}">{{ p }}</a>
                </li>
            {% endfor %}
            
            <li class="page-item {{ 'disabled' if page == total_pages else '' }}">
                <a class="page-link" href="{{ url_for(endpoint, page=page+1, **endpoint_args) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
</div>
{% endmacro %}

{% macro display_param_type_badge(config) %}
    {% if config.type.value == 'text' %}
        <span class="badge bg-info">{{ config.type_display }}</span>
    {% elif config.type.value == 'numeric' %}
        <span class="badge bg-primary">{{ config.type_display }}</span>
    {% elif config.type.value == 'enum' %}
        {% set multiple_choice = config.configuration_values[1] == '1' if config.configuration_values else false %}
        <span class="badge bg-success">
            {{ 'Choix multiple' if multiple_choice else 'Choix' }}
        </span>
    {% else %}
        <span class="badge bg-secondary">{{ config.type_display }}</span>
    {% endif %}
{% endmacro %}

{% macro display_param_values(config) %}
{% if config.type.value == 'enum' %}
    {% if config.configuration_values and config.configuration_values|length > 1 %}
        {% set display_values = ", ".join(config.configuration_values[2:]) %}
        {% if config.configuration_values|length > 7 %}
            {{ display_values[:100] }}... ({{ config.configuration_values|length - 2 }} valeurs)
        {% else %}
            {{ display_values[:100] }}
            {% if display_values|length > 100 %}...{% endif %}
        {% endif %}
    {% else %}
        <span class="text-muted">Aucune valeur</span>
    {% endif %}
{% elif config.type.value == 'numeric' %}
    {% set default_value = config.configuration_values[0] if config.configuration_values and config.configuration_values|length > 0 else 'N/A' %}
    {% set min_value = config.configuration_values[1] if config.configuration_values|length > 1 else none %}
    {% set max_value = config.configuration_values[2] if config.configuration_values|length > 2 else none %}
    
    <span class="numeric-values">
        Défaut : {{ default_value }}
        {% if min_value or max_value %}
            <span class="text-muted">
                {% if min_value %}(min: {{ min_value }}{% if max_value %}, {% endif %}{% endif %}
                {% if max_value %}max: {{ max_value }}{% endif %}
                )
            </span>
        {% endif %}
    </span>
{% else %}
    {{ config.configuration_values[0] if config.configuration_values and config.configuration_values|length > 0 else '' }}
{% endif %}
{% endmacro %}

{% macro display_param_rules(param) %}
    {% if param.type.value == 'numeric' %}
        Val: {{ param.configuration_values[0] }}
        {% if param.configuration_values|length > 1 %} 
            (Min: {{ param.configuration_values[1] }}, Max: {{ param.configuration_values[2] }})
        {% endif %}
    {% elif param.type.value == 'enum' %}
        Options: {{ param.configuration_values[2:]|join(', ') }}
    {% else %}
        Texte libre
    {% endif %}
{% endmacro %}

{% macro param_table(params, entity_type, entity_slug, editable=false) %}
<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Nom</th>
                <th>Type</th>
                <th>Règles</th>
                <th>Valeur</th>
                {% if editable %}<th class="text-end">Actions</th>{% endif %}
            </tr>
        </thead>
        <tbody>
            {% for param in params %}
            <tr>
                <td>{{ param.name }}</td>
                <td>{{ display_param_type_badge(param) }}</td>
                <td>{{ display_param_rules(param) }}</td>
                <td>
                    {% if editable %}
                        {{ display_editable_value(param) }}
                    {% else %}
                        {{ display_param_value(param) }}
                    {% endif %}
                </td>
                {% if editable %}
                <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger reset-param"
                            data-param-id="{{ param.id }}">
                        <i class="fas fa-undo"></i>
                    </button>
                </td>
                {% endif %}
            </tr>

            {# Ajouter ce bloc conditionnel pour les explications #}
            {% if editable %}
            <tr class="notes-row" id="notes-row-{{ param.id }}" style="display: none;">
                <td colspan="{% if editable %}5{% else %}4{% endif %}">
                    <div class="notes-container p-3 bg-light">
                        <textarea class="form-control" 
                                  name="notes_{{ param.id }}"
                                  placeholder="Explications sur les raisons de la modification (facultatif)"
                                  rows="2"></textarea>
                    </div>
                </td>
            </tr>
            {% endif %}

            {% endfor %}
        </tbody>
    </table>
</div>
{% endmacro %}

{% macro display_editable_value(param) %}
{% if param.type.value == 'enum' %}
    <select class="form-select form-select-sm param-value-input"
            name="param_{{ param.id }}"
            data-param-id="{{ param.id }}"
            data-original-value="{{ param.active_parameter.value if param.active_parameter else '' }}">
        {% for value in param.configuration_values[2:] %}
        <option value="{{ value }}" {{ 'selected' if param.active_parameter and value == param.active_parameter.value }}>
            {{ value }}
        </option>
        {% endfor %}
    </select>
{% else %}
    <input type="{{ 'number' if param.type.value == 'numeric' else 'text' }}"
           class="form-control form-control-sm param-value-input"
           name="param_{{ param.id }}"
           data-param-id="{{ param.id }}"
           data-original-value="{{ param.active_parameter.value if param.active_parameter else '' }}"
           value="{{ param.active_parameter.value if param.active_parameter else '' }}">
{% endif %}
{% endmacro %}
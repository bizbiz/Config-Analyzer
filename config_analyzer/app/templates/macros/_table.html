{# /templates/macros/_table.html #}

{#
/**
 * Macro data_table - Affiche un tableau de données avec des fonctionnalités avancées
 *
 * Cette macro génère un tableau de données complet avec support pour la recherche,
 * le tri, la pagination, et des actions personnalisables.
 *
 * @param entity_type       String  Type d'entité (ex: 'client', 'robot_model')
 * @param items             Array   Liste des éléments à afficher dans le tableau
 * @param title             String  Titre du tableau (facultatif)
 * @param icon              String  Icône FontAwesome (ex: 'users')
 * @param add_url           String  URL pour le bouton d'ajout (null pour masquer)
 * @param add_text          String  Texte du bouton d'ajout (défaut: "Ajouter")
 * @param actions           Bool    Afficher la colonne d'actions (défaut: true)
 * @param search            Bool    Activer la recherche (défaut: true)
 * @param pagination        Bool    Activer la pagination (défaut: true)
 * @param filters           Object  Configuration des filtres {nom: [options]}
 * @param sort_options      Array   Colonnes triables (défaut: [])
 * @param custom_row_classes Func   Fonction pour ajouter des classes aux lignes
 * @param additional_buttons Array   Boutons supplémentaires pour l'en-tête
 * @param show_export       Bool    Afficher le bouton d'exportation (défaut: false)
 * @param export_url        String  URL pour l'exportation
 * @param export_label      String  Texte du bouton d'exportation (défaut: "Exporter")
 * @param empty_message     String  Message quand aucun élément n'est trouvé
 * @param bulk_actions      Array   Actions en masse pour lignes sélectionnées
 * @param row_click_action  String  Action lors du clic sur une ligne (ex: 'view')
 * @param refresh_interval  Number  Intervalle de rafraîchissement en ms
 * @param table_class       String  Classes CSS additionnelles pour le tableau
 * @param show_count        Bool    Afficher le nombre d'éléments (défaut: true)
 * @param custom_actions    Object  Actions personnalisées {nom: {icon, label, url}}
 * @param table_id          String  ID du tableau (défaut: entity_type + "-table")
 * @param search_input_id   String  ID du champ de recherche
 * @param filter_columns    Number  Nombre de colonnes pour la recherche
 * @param tbody_id          String  ID du tbody
 * @param show_badge        Bool    Afficher badge avec nombre d'éléments
 * @param is_embedded       Bool    Indique si tableau est intégré dans un autre
 * @param hide_client       Bool    Masquer colonne client (tableaux intégrés)
 * @param hide_model        Bool    Masquer colonne modèle (tableaux intégrés)
 * @param show_sort         Bool    Afficher contrôles de tri (défaut: false)
 * @param show_search       Bool    Afficher champ de recherche (défaut: true)
 * @param search_placeholder String  Placeholder du champ de recherche
 * @param force_add_button  Bool    Forcer bouton d'ajout même si vide
 * @param hide_add_when_empty Bool   Masquer bouton d'ajout si liste vide
 * @param template_partial  String  Template partiel à utiliser pour corps tableau
 * @param context           Object  Contexte à passer au template partiel
 *
 * Exemple d'utilisation basique:
 * {{ data_table(
 *     entity_type='client',
 *     items=clients,
 *     title='Liste des clients',
 *     icon='users',
 *     add_url=url_for('clients.add'),
 *     template_partial='list/partials/clients.html',
 *     context={
 *         'items': clients,
 *         'show_add_button': false
 *     }
 * ) }}
 *
 * Exemple avec options avancées:
 * {{ data_table(
 *     entity_type='client',
 *     items=clients,
 *     title='Liste des clients',
 *     icon='users',
 *     add_url=url_for('clients.add'),
 *     search=true,
 *     pagination=true,
 *     filters={'country': countries},
 *     sort_options=['name', 'city'],
 *     show_export=true,
 *     export_url=url_for('clients.export'),
 *     template_partial='list/partials/clients.html',
 *     context={
 *         'items': clients,
 *         'show_search': true,
 *         'show_actions': true
 *     },
 *     bulk_actions=[
 *         {'label': 'Supprimer', 'icon': 'trash', 'action': 'delete'}
 *     ]
 * ) }}
 */
#}

{% macro data_table(
    entity_type,
    items,
    title=None,
    icon=None,
    add_url=None,
    add_text="Ajouter",
    show_add_button=true,
    actions=true,
    search=true,
    pagination=false,
    filters={},
    sort_options=[],
    custom_row_classes=None,
    additional_buttons=[],
    show_export=false,
    export_url=None,
    export_label="Exporter",
    empty_message="Aucun élément trouvé.",
    bulk_actions=[],
    row_click_action=None,
    refresh_interval=None,
    table_class="",
    show_count=true,
    custom_actions={},
    table_id=None,
    search_input_id=None,
    filter_columns=3,
    tbody_id=None,
    show_badge=false,
    is_embedded=false,
    show_sort=false,
    show_search=true,
    search_placeholder=None,
    force_add_button=true,
    hide_add_when_empty=false,
    headers=[],
    columns=[],
    column_links={},
    view_url_pattern=None,
    delete_message="Êtes-vous sûr de vouloir supprimer cet élément ?"
) %}
    {# Calcul des IDs du tableau si non fournis #}
    {% set table_id = table_id|default(entity_type + 'Table') %}
    {% set search_input_id = search_input_id|default(entity_type + 'SearchInput') %}
    {% set tbody_id = tbody_id|default(entity_type + '-table-body') %}
    {% set search_placeholder = search_placeholder|default('Rechercher un ' + entity_type + '...') %}

    <div class="card {% if not is_embedded %}mt-4{% endif %}">
        {# En-tête avec titre et boutons d'action #}
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                {% if icon %}<i class="fas fa-{{ icon }} me-2"></i>{% endif %}
                {{ title }}
                {% if show_badge %}
                <span class="badge bg-primary ms-2">{{ items|length }}</span>
                {% endif %}
            </h5>
            
            <div class="d-flex">
                {# Boutons supplémentaires #}
                {% for button in additional_buttons %}
                <a href="{{ button.url }}" class="btn btn-sm {{ button.class|default('btn-secondary') }} me-2">
                    {% if button.icon %}<i class="fas fa-{{ button.icon }} me-1"></i>{% endif %}
                    {{ button.text }}
                </a>
                {% endfor %}
                
                {# Bouton d'exportation si activé #}
                {% if show_export and export_url %}
                <a href="{{ export_url }}" class="btn btn-sm btn-secondary me-2">
                    <i class="fas fa-download me-1"></i>{{ export_label }}
                </a>
                {% endif %}
                
                {# Bouton d'ajout #}
                {% if add_url and show_add_button and (items|length > 0 or not hide_add_when_empty or force_add_button) %}
                <a href="{{ add_url }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus me-1"></i>{{ add_text }}
                </a>
                {% endif %}
            </div>
        </div>
        
        <div class="card-body">
            {% if items|length > 0 %}
                {# Champ de recherche #}
                {% if search and show_search %}
                <div class="mb-3">
                    <input type="text" id="{{ search_input_id }}" class="form-control" 
                           placeholder="{{ search_placeholder }}">
                </div>
                {% endif %}
                
                {# Tableau principal - rendu direct sans template partiel #}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle {{ table_class }}" 
                           id="{{ table_id }}"
                           data-list-filter="{{ 'true' if search else 'false' }}"
                           data-filter-input="{{ search_input_id }}" 
                           data-filter-columns="{{ filter_columns }}">
                        <thead class="table-light">
                            <tr>
                                {% if bulk_actions|length > 0 %}
                                <th class="bulk-select-column">
                                    <input type="checkbox" class="select-all-checkbox">
                                </th>
                                {% endif %}
                                
                                {% for header in headers %}
                                <th>{{ header }}</th>
                                {% endfor %}
                                
                                {% if actions %}
                                <th class="actions-column">Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody id="{{ tbody_id }}">
                            {% for item in items %}
                            <tr {% if custom_row_classes %}class="{{ custom_row_classes(item) }}"{% endif %}
                                {% if row_click_action %}data-clickable="true"{% endif %}>
                                
                                {% if bulk_actions|length > 0 %}
                                <td class="bulk-select-column">
                                    <input type="checkbox" class="row-checkbox" data-id="{{ item.id }}">
                                </td>
                                {% endif %}
                                
                                {% for column in columns %}
                                <td>
                                    {# Gestion sécurisée des attributs imbriqués #}
                                    {% set attr_parts = column.split('.') %}
                                    {% set value = item %}
                                    
                                    {% for attr in attr_parts %}
                                        {% if value is defined and value is not none %}
                                            {% if value is mapping %}
                                                {% set value = value[attr]|default('') %}
                                            {% else %}
                                                {% try %}
                                                    {% set value = attribute(value, attr) %}
                                                {% except %}
                                                    {% set value = '' %}
                                                {% endtry %}
                                            {% endif %}
                                        {% else %}
                                            {% set value = '' %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {# Gestion des liens pour cette colonne si définis #}
                                    {% if column in column_links and value is not none and value != '' %}
                                        {% set item_id = item.id|default('') %}
                                        {% set item_slug = item.slug|default('') %}
                                        {% set column_url = column_links[column]|replace('%id%', item_id)|replace('%slug%', item_slug) %}
                                        <a href="{{ column_url }}">
                                            {{ value }}
                                        </a>
                                    {% elif loop.first and view_url_pattern %}
                                        {# Premier colonne est un lien par défaut si view_url_pattern est fourni #}
                                        {% set item_id = item.id|default('') %}
                                        {% set item_slug = item.slug|default('') %}
                                        {% set view_url = view_url_pattern|replace('%id%', item_id)|replace('%slug%', item_slug) %}
                                        <a href="{{ view_url }}">
                                            {{ value }}
                                        </a>
                                    {% else %}
                                        {{ value }}
                                    {% endif %}
                                </td>
                                {% endfor %}
                                
                                {% if actions %}
                                <td class="text-center">
                                    {% set item_id = item.id|default('') %}
                                    {% set item_slug = item.slug|default('') %}
                                    {% set view_route = entity_type + '.view' %}
                                    {% set edit_route = entity_type + '.edit' %}
                                    {% set delete_route = entity_type + '.delete' %}
                                    
                                    {% try %}
                                        {# URL de vue #}
                                        {% if custom_actions.view_url is defined %}
                                            {% set view_url = custom_actions.view_url|replace('%id%', item_id)|replace('%slug%', item_slug) %}
                                        {% else %}
                                            {% if item.slug is defined and item.slug %}
                                                {% set view_url = url_for(view_route, slug=item.slug) %}
                                            {% else %}
                                                {% set view_url = url_for(view_route, id=item.id) %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# URL d'édition #}
                                        {% if custom_actions.edit_url is defined %}
                                            {% set edit_url = custom_actions.edit_url|replace('%id%', item_id)|replace('%slug%', item_slug) %}
                                        {% else %}
                                            {% if item.slug is defined and item.slug %}
                                                {% set edit_url = url_for(edit_route, slug=item.slug) %}
                                            {% else %}
                                                {% set edit_url = url_for(edit_route, id=item.id) %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# URL de suppression #}
                                        {% if custom_actions.delete_url is defined %}
                                            {% set delete_url = custom_actions.delete_url|replace('%id%', item_id)|replace('%slug%', item_slug) %}
                                        {% else %}
                                            {% if item.slug is defined and item.slug %}
                                                {% set delete_url = url_for(delete_route, slug=item.slug) %}
                                            {% else %}
                                                {% set delete_url = url_for(delete_route, id=item.id) %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {{ action_buttons(
                                            view_url=view_url,
                                            edit_url=edit_url,
                                            delete_url=delete_url,
                                            delete_message=delete_message,
                                            additional_buttons=custom_actions.additional_buttons|default([])
                                        ) }}
                                    
                                    {% except %}
                                        <!-- Erreur de génération des URL d'action -->
                                    {% endtry %}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {# Initialisation de la recherche #}
                {% if search %}
                    {{ init_search(table_id, search_input_id) }}
                {% endif %}
                
                {# Pagination #}
                {% if pagination and total_pages is defined and total_pages > 1 %}
                    {{ pagination(page, total_pages, total_items, items|length, offset) }}
                {% endif %}
                
            {% else %}
                {# Message si aucun élément #}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>{{ empty_message }}
                    {% if add_url and (show_add_button and not hide_add_when_empty) %}
                        <a href="{{ add_url }}" class="alert-link">{{ add_text }}</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
{% endmacro %}

{# Macro action_buttons inchangée pour référence #}
{% macro action_buttons(view_url=None, edit_url=None, delete_url=None, delete_message="Êtes-vous sûr de vouloir supprimer cet élément ?", additional_buttons=[], is_td=true, return_to=request.url) %}
    {% if is_td %}<td class="text-center">{% endif %}
    
    {% if view_url %}
    <a href="{{ view_url }}" class="btn btn-sm btn-info me-1">
        <i class="fas fa-eye"></i>
    </a>
    {% endif %}
    
    {% if edit_url %}
    <a href="{{ edit_url }}" class="btn btn-sm btn-warning me-1">
        <i class="fas fa-edit"></i>
    </a>
    {% endif %}
    
    {% if delete_url %}
    <form action="{{ delete_url }}" method="POST" class="d-inline">
        <input type="hidden" name="return_to" value="{{ return_to }}">
        <button type="submit" class="btn btn-sm btn-danger" 
                onclick="return confirm('{{ delete_message }}')">
            <i class="fas fa-trash"></i>
        </button>
    </form>
    {% endif %}
    
    {% for button in additional_buttons %}
        {{ button|safe }}
    {% endfor %}
    
    {% if is_td %}</td>{% endif %}
{% endmacro %}

{# Init search - inchangé également #}
{% macro init_search(table_id, input_id, column_indexes=[], row_selector='tbody tr') %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initTableSearch('{{ table_id }}', '{{ input_id }}', {{ column_indexes|tojson }}, '{{ row_selector }}');
    });
</script>
{% endmacro %}

{# Macro pour la liste vide - simplifiée #}
{% macro alert_empty_list(message, add_url=None, add_text=None) %}
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>{{ message }}
    {% if add_url and add_text %}
        <a href="{{ add_url }}" class="alert-link">{{ add_text }}</a>
    {% endif %}
</div>
{% endmacro %}

{# Macro pour la pagination #}
{% macro pagination(page, total_pages, total_items, items_length, offset, endpoint=request.endpoint, endpoint_args=request.view_args) %}
<div class="d-flex justify-content-between align-items-center mt-3">
    <div>
        Affichage de {{ offset + 1 }} à {{ offset + items_length }} sur {{ total_items }} éléments
    </div>
    <nav aria-label="Navigation des pages">
        <ul class="pagination">
            <li class="page-item {{ 'disabled' if page == 1 else '' }}">
                <a class="page-link" href="{{ url_for(endpoint, page=page-1, **endpoint_args) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            
            {% set start_page = [1, page - 2]|max %}
            {% set end_page = [start_page + 4, total_pages]|min %}
            {% set start_page = [end_page - 4, 1]|max %}
            
            {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {{ 'active' if p == page else '' }}">
                    <a class="page-link" href="{{ url_for(endpoint, page=p, **endpoint_args) }}">{{ p }}</a>
                </li>
            {% endfor %}
            
            <li class="page-item {{ 'disabled' if page == total_pages else '' }}">
                <a class="page-link" href="{{ url_for(endpoint, page=page+1, **endpoint_args) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
</div>
{% endmacro %}

{# Affiche un badge de type de paramètre #}
{% macro display_param_type_badge(config) %}
    {% try %}
        {% if config.type and config.type.value == 'text' %}
            <span class="badge bg-info">{{ config.type_display }}</span>
        {% elif config.type and config.type.value == 'numeric' %}
            <span class="badge bg-primary">{{ config.type_display }}</span>
        {% elif config.type and config.type.value == 'enum' %}
            {% set multiple_choice = config.configuration_values and config.configuration_values|length > 1 and config.configuration_values[1] == '1' %}
            <span class="badge bg-success">
                {{ 'Choix multiple' if multiple_choice else 'Choix' }}
            </span>
        {% else %}
            <span class="badge bg-secondary">{{ config.type_display|default('Type inconnu') }}</span>
        {% endif %}
    {% except %}
        <span class="badge bg-secondary">Type inconnu</span>
    {% endtry %}
{% endmacro %}

{# Affiche les valeurs d'un paramètre #}
{% macro display_param_values(config) %}
{% try %}
    {% if config.type and config.type.value == 'enum' %}
        {% if config.configuration_values and config.configuration_values|length > 1 %}
            {% if config.configuration_values|length > 2 %}
                {% set values = config.configuration_values[2:] %}
                {% set display_values = values|join(', ') %}
                {% if display_values|length > 100 %}
                    {{ display_values[:100] }}... ({{ values|length }} valeurs)
                {% else %}
                    {{ display_values }}
                {% endif %}
            {% else %}
                <span class="text-muted">Aucune valeur</span>
            {% endif %}
        {% else %}
            <span class="text-muted">Aucune valeur</span>
        {% endif %}
    {% elif config.type and config.type.value == 'numeric' %}
        {% if config.configuration_values %}
            {% set default_value = config.configuration_values[0] if config.configuration_values|length > 0 else 'N/A' %}
            {% set min_value = config.configuration_values[1] if config.configuration_values|length > 1 else none %}
            {% set max_value = config.configuration_values[2] if config.configuration_values|length > 2 else none %}
            
            <span class="numeric-values">
                Défaut : {{ default_value }}
                {% if min_value or max_value %}
                    <span class="text-muted">
                        {% if min_value %}(min: {{ min_value }}{% if max_value %}, {% endif %}{% endif %}
                        {% if max_value %}max: {{ max_value }}{% endif %}
                        )
                    </span>
                {% endif %}
            </span>
        {% else %}
            <span class="text-muted">Valeur par défaut non définie</span>
        {% endif %}
    {% else %}
        {% if config.configuration_values and config.configuration_values|length > 0 %}
            {{ config.configuration_values[0] }}
        {% else %}
            <span class="text-muted">Valeur non définie</span>
        {% endif %}
    {% endif %}
{% except %}
    <span class="text-muted">Erreur d'affichage</span>
{% endtry %}
{% endmacro %}

{# Affiche les règles d'un paramètre #}
{% macro display_param_rules(param) %}
{% try %}
    {% if param.type and param.type.value == 'numeric' %}
        {% if param.configuration_values %}
            Val: {{ param.configuration_values[0]|default('N/A') }}
            {% if param.configuration_values|length > 1 %} 
                (Min: {{ param.configuration_values[1]|default('N/A') }}, 
                Max: {{ param.configuration_values[2]|default('N/A') }})
            {% endif %}
        {% else %}
            <span class="text-muted">Règles non définies</span>
        {% endif %}
    {% elif param.type and param.type.value == 'enum' %}
        {% if param.configuration_values and param.configuration_values|length > 2 %}
            Options: {{ param.configuration_values[2:]|join(', ') }}
        {% else %}
            <span class="text-muted">Options non définies</span>
        {% endif %}
    {% else %}
        Texte libre
    {% endif %}
{% except %}
    <span class="text-muted">Règles non disponibles</span>
{% endtry %}
{% endmacro %}